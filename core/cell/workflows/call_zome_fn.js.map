{"version":3,"file":"call_zome_fn.js","sourceRoot":"","sources":["../../../../src/core/cell/workflows/call_zome_fn.ts"],"names":[],"mappings":"AAEA,OAAO,EAAE,UAAU,EAAE,MAAM,qBAAqB,CAAC;AACjD,OAAO,EAAE,aAAa,EAAE,MAAM,uBAAuB,CAAC;AACtD,OAAO,EAAE,oBAAoB,EAAE,MAAM,mBAAmB,CAAC;AAEzD;;;GAGG;AACH,MAAM,CAAC,MAAM,UAAU,GAAG,CACxB,IAAY,EACZ,MAAc,EACd,OAAY,EACZ,GAAW,EACX,EAAE,CAAC,KAAK,EAAE,IAAU,EAAgB,EAAE;IACtC,MAAM,aAAa,GAAG,aAAa,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;IAEhD,IAAI,CAAC,IAAI,CAAC,YAAY;QACpB,MAAM,IAAI,KAAK,CACb,+DAA+D,CAChE,CAAC;IAEJ,IAAI,CAAC,IAAI,CAAC,YAAY,CAAC,KAAK,CAAC,IAAI,CAAC;QAChC,MAAM,IAAI,KAAK,CAAC,kCAAkC,IAAI,cAAc,CAAC,CAAC;IAExE,IAAI,CAAC,IAAI,CAAC,YAAY,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC;QACxC,MAAM,IAAI,KAAK,CACb,mCAAmC,MAAM,+BAA+B,IAAI,EAAE,CAC/E,CAAC;IAEJ,MAAM,OAAO,GAAgB,IAAI,CAAC,YAAY,CAAC,KAAK,CAAC,IAAI,CAAC,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC,CAAC;IAE5E,IAAI,MAAM,CAAC;IACX,KAAK,MAAM,MAAM,IAAI,OAAO,EAAE;QAC5B,MAAM,OAAO,GAAG,MAAM,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAEzC,UAAU,CAAC,OAAO,CAAC,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC;QAEhC,MAAM,GAAG,OAAO,CAAC;KAClB;IAED,IAAI,aAAa,CAAC,IAAI,CAAC,KAAK,CAAC,IAAI,aAAa,EAAE;QAC9C,gBAAgB;QAEhB,gCAAgC;QAChC,IAAI,CAAC,eAAe,CAAC,oBAAoB,CAAC,IAAI,CAAC,CAAC,CAAC;KAClD;IAED,OAAO,MAAM,CAAC;AAChB,CAAC,CAAC","sourcesContent":["import { Cell } from '../../cell';\nimport { HdkAction } from '../source-chain/actions';\nimport { putElement } from '../source-chain/put';\nimport { getTipOfChain } from '../source-chain/utils';\nimport { produce_dht_ops_task } from './produce_dht_ops';\n\n/**\n * Calls the zome function of the cell DNA\n * This can only be called in the simulated mode: we can assume that cell.simulatedDna exists\n */\nexport const callZomeFn = (\n  zome: string,\n  fnName: string,\n  payload: any,\n  cap: string\n) => async (cell: Cell): Promise<any> => {\n  const currentHeader = getTipOfChain(cell.state);\n\n  if (!cell.simulatedDna)\n    throw new Error(\n      `Trying to do a simulated call to a cell that is not simulated`\n    );\n\n  if (!cell.simulatedDna.zomes[zome])\n    throw new Error(`There is no zome with the name ${zome} in this DNA`);\n\n  if (!cell.simulatedDna.zomes[zome][fnName])\n    throw new Error(\n      `There is function with the name ${fnName} in this zome with the name ${zome}`\n    );\n\n  const actions: HdkAction[] = cell.simulatedDna.zomes[zome][fnName](payload);\n\n  let result;\n  for (const action of actions) {\n    const element = await action(cell.state);\n\n    putElement(element)(cell.state);\n\n    result = element;\n  }\n\n  if (getTipOfChain(cell.state) != currentHeader) {\n    // Do validation\n\n    // Trigger production of DHT Ops\n    cell.triggerWorkflow(produce_dht_ops_task(cell));\n  }\n\n  return result;\n};\n"]}